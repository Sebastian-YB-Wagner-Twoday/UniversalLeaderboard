---
import type { Session } from "@auth/core/types";
import Layout from "../layouts/Layout.astro";
import { Auth, SignIn, SignOut } from "auth-astro/components";
import Dashboard from "../components/Dashboard.astro";
import background from "../assets/background.svg";

async function setUser(userName: string, email: string) {
  const body = JSON.stringify({
    userName: userName,
    email: email,
  });

  const response = await fetch("http://localhost:5212/users", {
    method: "POST",
    body: body,
    headers: { "Content-Type": "application/json" },
  });

  await response.json().catch((e) => console.log("there was an error: ", e));
}
---

<Layout>
  <img
    class="fixed top-0 left-0 w-screen h-full -z-10 blur-md"
    src={background.src}
    alt=""
    fetchpriority="high"
  />
  <main>
    <Auth>
      {
        (session: Session) => {
          if (session) {
            if (session.user?.name && session.user?.email) {
              setUser(session.user?.name, session.user?.email);
            }
          }

          return (
            <>
              {session ? (
                <SignOut>Logout</SignOut>
              ) : (
                <SignIn provider="github">Login</SignIn>
              )}
              <p>
                {session
                  ? `Logged in as ${session.user?.name}`
                  : "Not logged in"}
              </p>
            </>
          );
        }
      }
    </Auth>

    <Dashboard />
  </main>
</Layout>
