---
import type { Session } from "@auth/core/types";
import { Auth } from "auth-astro/components";
import CreateContestForm from "./CreateContestForm.vue";
import { getSession } from "auth-astro/server";
import type { Contest } from "../model/Contest.model";
import LeaderBoard from "./Leaderboard/LeaderBoard.vue";
import { columns } from "./Leaderboard/columns";
import ScoreForm from "./Leaderboard/ScoreForm.vue";

const session = await getSession(Astro.request);

const id = session?.user?.id;
let contests: Contest[]

if(id){
  const pagination = "0";

const url = "http://localhost:5212/users/" + id + "/contests/" + pagination;

const response = await fetch(url, {
  method: "GET",
  headers: { "Content-Type": "application/json" },
});

 contests = await response
  .json()
  .catch((e) => console.log("there was an error: ", e));

}

---

<div>
  <CreateContestForm client:load />

  <Auth
    ><div>
      {
        (session: Session) => (
        <p class="text-2xl">
        {session
            ? `Welcome ${session.user?.name}, here are your leaderboards:`
            : "Not logged in"}
        </p> 
        
          <div>
              {session ? contests.map((contest) =>
              <div>
                <ScoreForm contest={contest} client:load />
                <LeaderBoard columns={columns(contest.scoreType)} contest={contest} />
              </div>
              ):""}
          </div> 
        
        )
      }

    </div>
  </Auth>
</div>
